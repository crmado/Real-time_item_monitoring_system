# 🖼️ 合成調試圖片功能 - 使用指南

## 📖 概述

合成調試圖片功能將原本分散的 7 張調試圖片合併為 1 張大圖，讓您更容易分析檢測流程的每個階段。

## 🎯 主要特點

### ✅ 優勢
- **📸 6-in-1 布局**：所有分析階段一目瞭然
- **💾 大幅減少檔案數量**：從每幀 7 個檔案 → 1 個檔案
- **🔍 更容易對比分析**：方便查看前後景分離效果
- **📊 詳細參數信息**：包含完整的檢測參數
- **🎨 統一尺寸**：所有子圖統一格式，便於比較

### 🖼️ 圖片佈局 (3x2)
```
[1. 原始圖+ROI]  [2. ROI區域]     [3. 前景遮罩]
[4. 合併檢測]    [5. 最終處理]    [6. 檢測物件]
               [底部參數信息欄]
```

## 🚀 如何使用

### 方法一：使用標準主系統（推薦）

1. **啟動系統**
   ```bash
   cd /Users/crmado/github/Real-time_item_monitoring_system
   python basler_mvc_launcher.py
   ```

2. **切換檢測方法**
   - 在右側控制面板選擇「背景減除檢測」
   - 合成調試功能會自動啟用

3. **開始檢測**
   - 連接相機或載入視頻
   - 點擊「開始檢測」

### 方法二：使用調試版本啟動

1. **啟動調試版本**
   ```bash
   cd /Users/crmado/github/Real-time_item_monitoring_system
   python run_main_with_debug.py
   ```

2. **按提示操作**
   - 系統會顯示調試功能狀態
   - 提供詳細的使用說明

## 📁 檔案結構

### 保存位置
```
basler_mvc/recordings/composite_debug/
└── composite_YYYYMMDD_HHMMSS/
    ├── session_info.txt
    ├── composite_debug_0001_timestamp.jpg
    ├── composite_debug_0002_timestamp.jpg
    └── ...
```

### 檔案說明
- **session_info.txt**：會話信息和參數設定
- **composite_debug_XXXX_timestamp.jpg**：合成調試圖片
- **XXXX**：4位數幀編號（0001, 0002, ...）
- **timestamp**：毫秒級時間戳

## 🔧 參數設定

### 預設設定
```python
max_debug_frames = 200      # 最多保存 200 張調試圖片
target_height = 300         # 統一子圖高度
target_width = 400          # 統一子圖寬度
composite_debug_enabled = True  # 預設啟用
```

### 調整方法
可在 `enhanced_detection_method.py` 中修改：
```python
# 限制調試圖片數量
self.max_debug_frames = 100

# 調整子圖尺寸
target_height = 250
target_width = 350
```

## 📊 圖片內容說明

### 子圖說明

1. **原始圖+ROI**：完整原圖，綠色框標示ROI區域
2. **ROI區域**：裁切的ROI區域，實際檢測範圍
3. **前景遮罩**：背景減除後的前景檢測結果
4. **合併檢測**：多方法檢測結果合併
5. **最終處理**：形態學處理後的最終結果
6. **檢測物件**：標註檢測到的物件（綠框+面積）

### 底部參數信息
- **Frame**：幀編號
- **Count**：穿越計數
- **Objects**：檢測到的物件數
- **ROI**：ROI高度和位置
- **MinArea/MaxArea**：面積過濾範圍
- **BG Threshold**：背景減除閾值
- **Binary**：二值化閾值
- **Canny**：邊緣檢測閾值範圍
- **Time**：時間戳

## 🛠️ 故障排除

### 常見問題

1. **圖片尺寸錯誤**
   - 原因：不同子圖尺寸不匹配
   - 解決：已修復，使用固定尺寸 + 居中對齊

2. **調試圖片未生成**
   - 檢查是否選擇了「背景減除檢測」
   - 確認調試功能已啟用
   - 查看日誌是否有錯誤信息

3. **檔案過多**
   - 調整 `max_debug_frames` 參數
   - 定期清理調試資料夾

### 日誌檢查
```bash
# 查看系統日誌
tail -f basler_debug.log

# 搜索調試相關信息
grep "合成調試" basler_debug.log
```

## 🎯 分析技巧

### 如何分析檢測問題

1. **對比前後景**：查看圖3（前景遮罩）是否正確捕獲物件
2. **檢查ROI設定**：確認圖2（ROI區域）包含所有目標物件
3. **分析形態學效果**：比較圖4和圖5，查看去噪效果
4. **驗證最終檢測**：圖6顯示實際檢測到的物件

### 參數調優指南

- **前景遮罩太敏感**：增加 `bg_var_threshold`
- **漏檢小零件**：降低 `min_area`
- **檢測到雜訊**：調整形態學參數
- **邊緣檢測不足**：降低 Canny 閾值

## 📈 性能影響

### 資源使用
- **CPU**：圖片合成增加約 5-10% CPU 使用
- **記憶體**：臨時增加約 50MB
- **儲存空間**：每張合成圖約 500KB-1MB

### 優化建議
- 適當設定 `max_debug_frames` 限制
- 定期清理舊的調試檔案
- 在不需要調試時可關閉功能

## 🔄 版本更新

### v1.0 特點
- ✅ 6-in-1 合成佈局
- ✅ 自動尺寸調整
- ✅ 詳細參數信息
- ✅ 主系統整合
- ✅ 錯誤處理和日誌

### 未來改進
- [ ] 可自定義佈局
- [ ] 交互式參數調整
- [ ] 批量分析工具
- [ ] 視頻導出功能

---

💡 **提示**：合成調試圖片是分析小零件檢測問題的強大工具，建議在調優檢測參數時善加利用！
