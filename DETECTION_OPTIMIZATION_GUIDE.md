# 🎯 檢測參數優化指南

## 📊 基於合成調試圖片的參數分析

根據您的 200 張合成調試圖片分析，我已對檢測參數進行了全面優化。

## 🔧 核心參數優化

### ⚡ 主要改進項目

#### 1. **面積過濾更激進**
```python
# 舊設定 → 新設定
min_area = 15 → 8        # 捕獲更小零件
max_area = 3000 → 4000   # 適應更大零件
```

#### 2. **形狀過濾更寬鬆**
```python
min_aspect_ratio = 0.005 → 0.003   # 允許更極端長寬比
max_aspect_ratio = 15.0 → 20.0     # 適應細長零件
min_extent = 0.0005 → 0.0003       # 更低填充比例要求
max_solidity = 2.0 → 3.0           # 大幅放寬結實性
```

#### 3. **背景減除更敏感**
```python
bg_history = 600 → 500             # 減少歷史幀數
bg_var_threshold = 5 → 3           # 更敏感的前景檢測
```

#### 4. **邊緣檢測更細緻**
```python
canny_low_threshold = 10 → 8       # 捕獲更弱邊緣
canny_high_threshold = 40 → 35     # 保留更多邊緣
binary_threshold = 8 → 5           # 更敏感的二值化
```

#### 5. **追蹤優化**
```python
track_lifetime = 8 → 5             # 適應快速移動
crossing_threshold = 0.05 → 0.03   # 更敏感穿越檢測
confidence_threshold = 0.05 → 0.03 # 更低置信度要求
```

## 🎮 測試建議

### 🔍 階段性測試流程

#### **第1階段：基礎驗證**
1. 選擇有明顯白點零件的測試視頻
2. 使用回放模式 + 背景減除檢測
3. 觀察第1-50幀的合成調試圖片

**重點檢查：**
- 圖3（前景遮罩）：白點是否被正確捕獲？
- 圖6（檢測物件）：綠框是否標註了所有可見零件？

#### **第2階段：參數微調**
如果仍有遺漏，可進一步調整：

**A. 前景檢測不足**
```python
self.bg_var_threshold = 2    # 更敏感 (當前=3)
self.bg_history = 400        # 更短歷史 (當前=500)
```

**B. 小零件被過濾**
```python
self.min_area = 5           # 更小面積 (當前=8)
self.min_extent = 0.0001    # 更低填充要求 (當前=0.0003)
```

**C. 邊緣檢測不足**
```python
self.canny_low_threshold = 5    # 更敏感 (當前=8)
self.binary_threshold = 3       # 更低閾值 (當前=5)
```

#### **第3階段：性能平衡**
```python
# 如果檢測過於敏感，產生太多雜訊
self.bg_var_threshold = 4       # 稍微提高
self.min_area = 10             # 適度提高最小面積
```

## 📸 調試圖片模式控制

### ✅ 正確的使用方式

**合成調試圖片只在視頻回放模式啟用：**

| 系統模式 | 調試圖片 | 原因 |
|----------|----------|------|
| 即時模式 | ❌ 禁用 | 影響性能，不需要分析 |
| 錄製模式 | ❌ 禁用 | 專注錄製，避免干擾 |
| 回放模式 | ✅ 啟用 | 最適合調試分析 |

**自動控制邏輯：**
```python
# 系統會自動根據模式啟用/禁用
if mode in ["live", "recording"]:
    # 自動禁用調試功能
elif mode == "playback":
    # 啟用合成調試功能
```

## 🔍 合成調試圖片分析技巧

### 📊 6-in-1 圖片解讀

#### **圖1: 原始圖+ROI**
- ✅ 檢查ROI框是否覆蓋所有目標區域
- ✅ 確認零件是否在ROI範圍內

#### **圖2: ROI區域**
- ✅ 觀察裁切後的實際檢測範圍
- ✅ 確認圖像品質是否足夠清晰

#### **圖3: 前景遮罩**
- 🎯 **最關鍵**：白色區域是否對應所有零件？
- 🎯 是否有雜訊（不相關的白點）？

#### **圖4: 合併檢測**
- ✅ 多方法檢測的綜合結果
- ✅ 比較與圖3的差異

#### **圖5: 最終處理**
- ✅ 形態學處理後的結果
- ✅ 檢查是否過度去噪

#### **圖6: 檢測物件**
- 🎯 **最終結果**：綠框是否標註所有零件？
- 🎯 面積數值是否合理？

### 🔧 常見問題診斷

#### **問題1：前景遮罩有白點，但圖6沒有綠框**
**原因：** 面積或形狀過濾太嚴格
**解決：** 降低 `min_area` 或放寬形狀參數

#### **問題2：圖6有很多錯誤檢測（雜訊）**
**原因：** 背景減除太敏感
**解決：** 提高 `bg_var_threshold` 或加強形態學處理

#### **問題3：小零件檢測不穩定**
**原因：** 追蹤參數需要調整
**解決：** 縮短 `track_lifetime` 或調整容差

## 📈 性能優化建議

### ⚡ 檢測速度優化
- 限制調試圖片數量：`max_debug_frames = 100`
- 只在必要時啟用調試模式
- 定期清理舊的調試資料

### 💾 儲存空間管理
```bash
# 定期清理調試資料
cd basler_mvc/recordings/composite_debug
rm -rf composite_*  # 清理所有調試會話
```

## 🎯 下一步行動

### 1. **立即測試**
```bash
cd /Users/crmado/github/Real-time_item_monitoring_system
python basler_mvc_launcher.py
```

### 2. **設定測試**
- 切換到「回放模式」
- 選擇「背景減除檢測」
- 載入您的測試視頻

### 3. **分析結果**
- 檢查新生成的合成調試圖片
- 對比優化前後的檢測效果
- 根據實際結果微調參數

### 4. **效果評估**
- 統計檢測準確率提升
- 記錄遺漏的零件類型
- 調整特定參數針對性優化

---

💡 **重要提醒**：這些參數已經極度激進，如果仍有檢測問題，可能需要：
1. 檢查影像品質
2. 調整ROI位置
3. 考慮光源條件
4. 評估零件特徵
