# 🎬 工業相機視頻錄製和回放測試系統

## 🎯 系統概覽

本系統實現了工業相機視頻錄製和回放測試功能，與現有的檢測算法無縫整合。您可以使用相同的相機參數錄製視頻，然後用錄製的視頻反覆測試和調整檢測算法，最後將調好的參數直接應用到實時系統中。

## ✨ 核心特性

### 📹 **連動式設計**

- **相機參數保持**: 錄製時使用相同的曝光時間、增益等設定
- **算法參數統一**: 實時和回放模式使用相同的檢測算法
- **無縫切換**: 在三種模式間切換時保持所有設定

### 🔄 **三種工作模式**

1. **實時模式 (Live)**: 原有的實時檢測功能
2. **錄製模式 (Recording)**: 實時檢測 + 同步視頻錄製
3. **回放模式 (Playback)**: 視頻檔案回放 + 算法測試

### 🧠 **智能數據源識別**

- **DetectionModel 自動優化**: 根據數據源（相機/視頻）自動調整處理參數
- **相機模式**: 高性能處理（resize_factor=0.5）
- **視頻模式**: 品質優先處理（resize_factor=0.8）

## 📁 系統架構

### 新增核心組件

```
basler_mvc/
├── models/
│   ├── video_recorder_model.py    # 視頻錄製數據模型
│   ├── video_player_model.py      # 視頻播放數據模型
│   └── detection_model.py         # 擴展：支持數據源區分
├── controllers/
│   └── main_controller.py         # 擴展：視頻控制功能
└── views/
    └── main_view.py               # 擴展：視頻控制UI面板
```

### MVC 架構分離關注點

- **Models**: 專注數據管理和業務邏輯
- **Views**: 專注用戶界面和交互
- **Controllers**: 協調模型間的業務流程

## 🚀 使用流程

### 📹 **錄製工作流程**

1. **設定工業相機**

   ```
   🔗 連接相機 → 🎛️ 調整參數 → ▶️ 啟動實時檢測
   ```

2. **開始同步錄製**

   ```
   🎬 切換到錄製模式 → 📝 設定檔名 → 🔴 開始錄製
   ```

   - 系統同時進行實時檢測和視頻錄製
   - 錄製的視頻包含完整的相機設定效果
   - 實時檢測結果可供參考

3. **完成錄製**
   ```
   ⏹️ 停止錄製 → 📊 查看統計 → 💾 視頻自動保存
   ```

### 🎮 **回放測試流程**

1. **切換回放模式**

   ```
   🎬 切換到回放模式 → 📁 選擇錄製視頻 → 📋 保持檢測參數
   ```

2. **調整算法參數**

   ```
   🎯 修改檢測參數 → ▶️ 播放視頻 → 👀 觀察檢測效果
   ```

   - 支援播放/暫停/跳轉
   - 可調整播放速度
   - 實時查看參數調整效果

3. **應用優化參數**
   ```
   🔄 切換實時模式 → ✅ 參數自動應用 → 🎯 實時檢測
   ```

## 🎛️ 界面控制

### 模式選擇

- **實時**: 原有實時檢測功能
- **錄製**: 實時檢測 + 視頻錄製
- **回放**: 視頻回放 + 算法測試

### 錄製控制

- **檔名設定**: 自動時間戳命名
- **錄製狀態**: 實時顯示錄製進度
- **錄製統計**: 顯示幀數、時長等信息

### 回放控制

- **文件選擇**: 支援多種視頻格式
- **播放控制**: 播放/暫停/停止/跳轉
- **速度調整**: 0.1x - 3.0x 播放速度
- **進度顯示**: 實時進度條和幀數信息

## 💡 技術優化

### 🚀 **性能優化**

- **數據源適配**: 不同數據源使用不同的優化策略
- **記憶體管理**: 防止長時間運行記憶體洩漏
- **線程安全**: 確保 UI 響應性和處理穩定性

### 🔧 **錯誤處理**

- **完善異常處理**: 錄製/播放過程中的錯誤恢復
- **狀態同步**: UI 狀態與系統狀態實時同步
- **資源管理**: 自動釋放視頻資源

### 📊 **統計和監控**

- **錄製統計**: 幀數、時長、平均 FPS
- **播放信息**: 當前幀數、總幀數、進度
- **檢測性能**: 不同數據源的檢測效能對比

## 🔄 數據流程

### 錄製數據流

```
工業相機 → BaslerCameraModel → 同時發送至 → DetectionModel (實時檢測)
                                         → VideoRecorderModel (視頻錄製)
```

### 回放數據流

```
視頻檔案 → VideoPlayerModel → DetectionModel → MainView (檢測結果顯示)
```

### 參數同步流程

```
UI調整 → MainController → DetectionModel → 立即生效於當前模式
```

## 🎯 使用優勢

### 開發效率

- **離線調試**: 無需重複設定相機即可測試算法
- **參數優化**: 快速迭代和比較不同參數效果
- **重現問題**: 保存特定場景的視頻用於問題重現

### 生產應用

- **標準化測試**: 使用相同視頻檔案測試不同算法版本
- **品質驗證**: 錄製生產線實際情況用於算法驗證
- **培訓材料**: 錄製標準操作流程作為培訓素材

### 系統維護

- **版本對比**: 比較不同算法版本的檢測效果
- **性能分析**: 分析不同場景下的檢測性能
- **問題診斷**: 保存異常情況的視頻用於後續分析

## 📂 文件組織

### 錄製文件

- **保存位置**: `recordings/` 目錄
- **命名規則**: `camera_rec_YYYYMMDD_HHMMSS.avi`
- **文件格式**: AVI (XVID 編碼)

### 支援格式

- **回放支援**: AVI, MP4, MOV, MKV
- **相容性**: 支援主流視頻格式
- **品質**: 保持原始相機解析度和幀率

這個系統讓您可以輕鬆地錄製測試素材，反覆調整算法參數，最終獲得最佳的檢測效果！🎯
