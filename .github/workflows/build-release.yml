name: Build Multi-Platform Release

# è§¸ç™¼æ¢ä»¶
on:
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: 2.0.3)'
        required: true
        type: string
      create_release:
        description: 'æ˜¯å¦å‰µå»º GitHub Release'
        required: true
        type: boolean
        default: false

  # æ¨é€æ¨™ç±¤æ™‚è‡ªå‹•è§¸ç™¼ (ä¾‹å¦‚: v2.0.3)
  push:
    tags:
      - 'v*.*.*'

  # Pull Request æ™‚é€²è¡Œæ¸¬è©¦æ‰“åŒ…ï¼ˆä¸ä¸Šå‚³ï¼‰
  pull_request:
    branches: [ master, main ]
    paths:
      - 'basler_pyqt6/**'
      - 'scripts/**'
      - 'basler_pyqt6.spec'
      - 'requirements.txt'

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          # Windows æ‰“åŒ…
          - os: windows-latest
            platform: windows
            artifact_name: BaslerVision-Windows
            installer_ext: .exe

          # macOS æ‰“åŒ…
          - os: macos-latest
            platform: macos
            artifact_name: BaslerVision-macOS
            installer_ext: .dmg

          # Linux æ‰“åŒ…
          - os: ubuntu-latest
            platform: linux
            artifact_name: BaslerVision-Linux
            installer_ext: .AppImage

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # ç²å–å®Œæ•´æ­·å²ä»¥ä¾¿æ­£ç¢ºç”Ÿæˆç‰ˆæœ¬è™Ÿ

      - name: ğŸ è¨­ç½® Python ç’°å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ å®‰è£ä¾è³´ (Windows)
        if: matrix.platform == 'windows'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # å®‰è£ Inno Setup (Windows å®‰è£ç¨‹åºç”Ÿæˆå™¨)
          choco install innosetup -y

      - name: ğŸ“¦ å®‰è£ä¾è³´ (macOS)
        if: matrix.platform == 'macos'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          # å®‰è£ create-dmg (macOS ç£ç¢Ÿæ˜ åƒç”Ÿæˆå™¨)
          brew install create-dmg

      - name: ğŸ“¦ å®‰è£ä¾è³´ (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ”¨ åŸ·è¡Œ PyInstaller æ‰“åŒ…
        run: |
          python scripts/build.py --no-package
        env:
          PYTHONUNBUFFERED: 1

      - name: ğŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [ "${{ github.event_name }}" == "push" ]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          else
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ ç‰ˆæœ¬è™Ÿ: $VERSION"

      - name: ğŸ å‰µå»º Windows å®‰è£ç¨‹åº
        if: matrix.platform == 'windows'
        run: |
          # è¨­ç½®ç’°å¢ƒè®Šé‡ä¾› Inno Setup ä½¿ç”¨
          $env:APP_VERSION="${{ steps.version.outputs.VERSION }}"
          # ç·¨è­¯å®‰è£ç¨‹åº
          iscc installer/windows_installer.iss
        shell: pwsh

      - name: ğŸ å‰µå»º macOS DMG å®‰è£åŒ…
        if: matrix.platform == 'macos'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          APP_NAME="BaslerVisionSystem"
          DMG_NAME="BaslerVision_v${VERSION}_macOS.dmg"

          # å‰µå»º .app çµæ§‹
          mkdir -p "dist/${APP_NAME}.app/Contents/MacOS"
          mkdir -p "dist/${APP_NAME}.app/Contents/Resources"

          # è¤‡è£½åŸ·è¡Œæ–‡ä»¶
          cp -R "dist/${APP_NAME}/"* "dist/${APP_NAME}.app/Contents/MacOS/"

          # å‰µå»º Info.plist
          cat > "dist/${APP_NAME}.app/Contents/Info.plist" <<EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>${APP_NAME}</string>
              <key>CFBundleIdentifier</key>
              <string>com.basler.visionsystem</string>
              <key>CFBundleName</key>
              <string>Basler Vision System</string>
              <key>CFBundleVersion</key>
              <string>${VERSION}</string>
              <key>CFBundleShortVersionString</key>
              <string>${VERSION}</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF

          # å‰µå»º DMG
          create-dmg \
            --volname "Basler Vision System" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "releases/${DMG_NAME}" \
            "dist/${APP_NAME}.app"

      - name: ğŸ å‰µå»º Linux AppImage
        if: matrix.platform == 'linux'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          APP_NAME="BaslerVisionSystem"
          APPIMAGE_NAME="BaslerVision_v${VERSION}_Linux.AppImage"

          # å®‰è£ FUSEï¼ˆlinuxdeploy éœ€è¦ï¼‰
          sudo apt-get update
          sudo apt-get install -y fuse libfuse2

          # ä¸‹è¼‰ linuxdeploy
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          chmod +x linuxdeploy-x86_64.AppImage

          # å‰µå»º AppDir çµæ§‹
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # è¤‡è£½æ‡‰ç”¨ç¨‹å¼
          cp -R dist/${APP_NAME}/* AppDir/usr/bin/

          # å‰µå»º .desktop æ–‡ä»¶
          cat > AppDir/usr/share/applications/${APP_NAME}.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Basler Vision System
          Comment=å·¥æ¥­è¦–è¦ºæª¢æ¸¬ç³»çµ±
          Exec=${APP_NAME}
          Icon=${APP_NAME}
          Categories=Utility;
          Terminal=false
          EOF

          # å‰µå»º AppRunï¼ˆå…¥å£è…³æœ¬ï¼‰
          cat > AppDir/AppRun <<'APPRUN_EOF'
          #!/bin/bash
          SELF=$(readlink -f "$0")
          HERE=${SELF%/*}
          export PATH="${HERE}/usr/bin/:${HERE}/usr/sbin/:${HERE}/usr/games/:${HERE}/bin/:${HERE}/sbin/${PATH:+:$PATH}"
          export LD_LIBRARY_PATH="${HERE}/usr/lib/:${HERE}/usr/lib/i386-linux-gnu/:${HERE}/usr/lib/x86_64-linux-gnu/:${HERE}/usr/lib32/:${HERE}/usr/lib64/${LD_LIBRARY_PATH:+:$LD_LIBRARY_PATH}"
          export PYTHONPATH="${HERE}/usr/share/pyshared/${PYTHONPATH:+:$PYTHONPATH}"
          EXEC=$(grep -e '^Exec=.*' "${HERE}"/*.desktop | head -n 1 | cut -d "=" -f 2 | cut -d " " -f 1)
          exec "${HERE}/usr/bin/${EXEC}" "$@"
          APPRUN_EOF
          chmod +x AppDir/AppRun

          # å‰µå»º AppImageï¼ˆä½¿ç”¨ extract-and-run æ¨¡å¼é¿å… FUSE å•é¡Œï¼‰
          ARCH=x86_64 ./linuxdeploy-x86_64.AppImage --appimage-extract-and-run \
            --appdir AppDir \
            --executable AppDir/usr/bin/${APP_NAME} \
            --desktop-file AppDir/usr/share/applications/${APP_NAME}.desktop \
            --output appimage || {
              echo "âš ï¸ linuxdeploy å¤±æ•—ï¼Œä½¿ç”¨ tar.gz å‚™ç”¨æ–¹æ¡ˆ..."

              # å‚™ç”¨æ–¹æ¡ˆï¼šå‰µå»ºå¯ç›´æ¥ä½¿ç”¨çš„ tar.gz åŒ…
              mkdir -p releases
              cd AppDir

              # å‰µå»ºç°¡çŸ­çš„å¿«é€Ÿå•Ÿå‹•æŒ‡å—ï¼ˆæ”¾åœ¨æ ¹ç›®éŒ„ï¼‰
              cat > README.txt <<'README_EOF'
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            Basler Vision System - Linux å¿«é€Ÿå•Ÿå‹•
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          âš ï¸  æ³¨æ„ï¼šæ­¤äºŒé€²åˆ¶æ–‡ä»¶åƒ…æ”¯æ´ x86_64 æ¶æ§‹

          å¦‚æœæ‚¨ä½¿ç”¨ ARM è¨­å‚™ï¼ˆRock 5B, æ¨¹è“æ´¾ç­‰ï¼‰æˆ–é‡åˆ°åŸ·è¡ŒéŒ¯èª¤ï¼Œ
          è«‹å¾æºç¢¼å®‰è£ï¼š

            git clone https://github.com/ä½ çš„ç”¨æˆ¶å/å°ˆæ¡ˆ.git
            cd Real-time_item_monitoring_system
            ./install_arm.sh    # ARM è¨­å‚™
            ./run.sh            # å•Ÿå‹•æ‡‰ç”¨

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          ğŸš€ x86_64 å¿«é€Ÿå®‰è£ï¼ˆUbuntu/Debianï¼‰ï¼š

          1. å®‰è£ä¾è³´ï¼š
             sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 \
                                     libxkbcommon-x11-0 libgl1-mesa-glx

          2. é€²å…¥ç›®éŒ„ï¼šcd usr/bin
          3. æ·»åŠ æ¬Šé™ï¼šchmod +x BaslerVisionSystem
          4. é‹è¡Œï¼š./BaslerVisionSystem

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          README_EOF

              # å‰µå»ºè©³ç´°å®‰è£èªªæ˜
              cat > INSTALL.txt <<'INSTALL_EOF'
          Basler Vision System - Linux å®‰è£èªªæ˜
          ========================================

          å¿«é€Ÿå®‰è£ï¼š

          1. å®‰è£ä¾è³´ï¼ˆUbuntu/Debianï¼‰ï¼š
             sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 libgl1-mesa-glx

          2. é€²å…¥è§£å£“ç›®éŒ„ï¼š
             cd usr/bin

          3. æ·»åŠ åŸ·è¡Œæ¬Šé™ä¸¦é‹è¡Œï¼š
             chmod +x BaslerVisionSystem
             ./BaslerVisionSystem

          å…¶ä»–ç™¼è¡Œç‰ˆæˆ–å®Œæ•´å®‰è£æŒ‡å—ï¼Œè«‹åƒé–±ï¼š
          https://github.com/ä½ çš„ç”¨æˆ¶å/å°ˆæ¡ˆå/blob/master/LINUX_INSTALL.md
          INSTALL_EOF

              tar czf "../releases/${APPIMAGE_NAME%.AppImage}.tar.gz" .
              cd ..

              # å‰µå»ºå®‰è£èªªæ˜æ‘˜è¦æ–‡ä»¶ï¼ˆç”¨æ–¼ Release notesï¼‰
              cat > "../releases/LINUX_INSTALL_NOTES.txt" <<'NOTES_EOF'
          âš ï¸ æ³¨æ„ï¼šæ­¤ç‰ˆæœ¬ä½¿ç”¨ tar.gz æ ¼å¼ï¼ˆAppImage æ‰“åŒ…å¤±æ•—ï¼‰

          è§£å£“å¾Œæœƒçœ‹åˆ°ï¼š
          - README.txt     â† å¿«é€Ÿå•Ÿå‹•æŒ‡å—ï¼ˆå…ˆçœ‹é€™å€‹ï¼ï¼‰
          - INSTALL.txt    â† è©³ç´°å®‰è£èªªæ˜
          - usr/bin/       â† æ‡‰ç”¨ç¨‹å¼ç›®éŒ„

          å¿«é€Ÿå®‰è£ï¼ˆUbuntu/Debianï¼‰ï¼š
          1. tar -xzf BaslerVision_*.tar.gz
          2. cat README.txt
          3. sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 libgl1-mesa-glx
          4. cd usr/bin && chmod +x BaslerVisionSystem && ./BaslerVisionSystem
          NOTES_EOF

              echo "âœ… å·²å‰µå»º tar.gz å‚™ç”¨åŒ…"
              echo "   åŒ…å«æ–‡ä»¶ï¼š"
              echo "   - README.txt (å¿«é€Ÿå•Ÿå‹•æŒ‡å—)"
              echo "   - INSTALL.txt (è©³ç´°å®‰è£èªªæ˜)"
              echo "   - usr/bin/BaslerVisionSystem (ä¸»ç¨‹å¼)"
              exit 0
            }

          # é‡å‘½å AppImage
          mkdir -p releases
          if ls *.AppImage 1> /dev/null 2>&1; then
            mv *.AppImage "releases/${APPIMAGE_NAME}"
            echo "âœ… AppImage å‰µå»ºæˆåŠŸ"
          else
            echo "âš ï¸ ä½¿ç”¨ tar.gz å‚™ç”¨æ–¹å¼"
          fi

      - name: ğŸ“¦ æº–å‚™ä¸Šå‚³ç”¢ç‰©
        shell: bash
        run: |
          # ç¢ºä¿ releases ç›®éŒ„å­˜åœ¨
          mkdir -p releases

          # å¦‚æœ releases ç›®éŒ„ç‚ºç©ºï¼ˆå®‰è£ç¨‹åºå‰µå»ºå¤±æ•—ï¼‰ï¼Œè¤‡è£½ dist å…§å®¹
          if [ -z "$(ls -A releases)" ]; then
            echo "âš ï¸ releases ç›®éŒ„ç‚ºç©ºï¼Œè¤‡è£½ dist å…§å®¹ä½œç‚ºå‚™ç”¨..."
            cd dist/BaslerVisionSystem
            zip -r "../../releases/BaslerVisionSystem-${{ matrix.platform }}-dist.zip" .
            cd ../..
            echo "âœ… å·²å‰µå»ºå‚™ç”¨å£“ç¸®åŒ…"
          fi

          # é¡¯ç¤ºå°‡è¦ä¸Šå‚³çš„æ–‡ä»¶
          echo "ğŸ“ å°‡ä¸Šå‚³ä»¥ä¸‹æ–‡ä»¶ï¼š"
          ls -lh releases/

      - name: ğŸ“¤ ä¸Šå‚³æ§‹å»ºç”¢ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-v${{ steps.version.outputs.VERSION }}
          path: releases/*
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ“Š é¡¯ç¤ºæ§‹å»ºä¿¡æ¯
        shell: bash
        run: |
          echo "âœ… æ§‹å»ºå®Œæˆï¼"
          echo "ğŸ“¦ å¹³å°: ${{ matrix.platform }}"
          echo "ğŸ“Œ ç‰ˆæœ¬: ${{ steps.version.outputs.VERSION }}"
          echo "ğŸ“ ç”¢ç‰©:"
          ls -lh releases/

  # å‰µå»º GitHub Releaseï¼ˆåƒ…åœ¨æ‰‹å‹•è§¸ç™¼ä¸”é¸æ“‡å‰µå»ºæ™‚ï¼‰
  create-release:
    name: å‰µå»º GitHub Release
    needs: build
    runs-on: ubuntu-latest
    # æ˜ç¢ºæˆäºˆå‰µå»º Release æ‰€éœ€çš„æ¬Šé™
    permissions:
      contents: write  # éœ€è¦å¯«å…¥æ¬Šé™ä¾†å‰µå»º Release
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true') ||
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/'))

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4

      - name: ğŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ“¥ ä¸‹è¼‰æ‰€æœ‰æ§‹å»ºç”¢ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“¦ æ•´ç†ç™¼å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release-files
          find artifacts -type f -exec cp {} release-files/ \;
          ls -lh release-files/

      - name: ğŸš€ å‰µå»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: Basler Vision System v${{ steps.version.outputs.VERSION }}
          body: |
            ## ğŸ‰ ç‰ˆæœ¬ ${{ steps.version.outputs.VERSION }}

            ### ğŸ“¦ ä¸‹è¼‰

            - **Windows**: `BaslerVision_Setup_v${{ steps.version.outputs.VERSION }}.exe`
            - **macOS**: `BaslerVision_v${{ steps.version.outputs.VERSION }}_macOS.dmg`
            - **Linux**: `BaslerVision_v${{ steps.version.outputs.VERSION }}_Linux.AppImage`

            ### ğŸ“‹ å®‰è£èªªæ˜

            #### Windows
            1. ä¸‹è¼‰ `.exe` å®‰è£ç¨‹åº
            2. ä»¥ç®¡ç†å“¡èº«ä»½é‹è¡Œ
            3. è·Ÿéš¨å®‰è£åš®å°å®Œæˆå®‰è£

            #### macOS
            1. ä¸‹è¼‰ `.dmg` ç£ç¢Ÿæ˜ åƒ
            2. é›™æ“Šæ›è¼‰
            3. å°‡æ‡‰ç”¨ç¨‹å¼æ‹–åˆ° Applications æ–‡ä»¶å¤¾

            #### Linux

            **å¦‚æœæ˜¯ AppImage æ ¼å¼**ï¼š
            ```bash
            chmod +x BaslerVision_*.AppImage
            ./BaslerVision_*.AppImage
            ```

            **å¦‚æœæ˜¯ tar.gz æ ¼å¼**ï¼ˆAppImage æ‰“åŒ…å¤±æ•—æ™‚çš„å‚™ç”¨æ–¹æ¡ˆï¼‰ï¼š
            ```bash
            # è§£å£“ç¸®
            tar -xzf BaslerVision_*.tar.gz

            # æŸ¥çœ‹å®‰è£èªªæ˜
            cat INSTALL.txt

            # å¿«é€Ÿå®‰è£ï¼ˆUbuntu/Debianï¼‰
            sudo apt-get install -y libxcb-xinerama0 libxcb-cursor0 libxkbcommon-x11-0 libgl1-mesa-glx
            cd usr/bin
            chmod +x BaslerVisionSystem
            ./BaslerVisionSystem
            ```

            ğŸ“– **å®Œæ•´ Linux å®‰è£æŒ‡å—**ï¼ˆåŒ…å«å…¶ä»–ç™¼è¡Œç‰ˆã€è‡ªå‹•å®‰è£è…³æœ¬ã€æ•…éšœæ’é™¤ï¼‰ï¼š
            [LINUX_INSTALL.md](LINUX_INSTALL.md)

            ### ğŸ”— ç›¸é—œéˆæ¥

            - [å®Œæ•´è®Šæ›´æ—¥èªŒ](CHANGELOG.md)
            - [ä½¿ç”¨æ–‡æª”](README.md)
            - [å•é¡Œåé¥‹](https://github.com/${{ github.repository }}/issues)

          files: release-files/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # é€šçŸ¥æ§‹å»ºçµæœï¼ˆå¯é¸ï¼‰
  notify:
    name: æ§‹å»ºçµæœé€šçŸ¥
    needs: [build, create-release]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“Š æª¢æŸ¥æ§‹å»ºç‹€æ…‹
        run: |
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… æ‰€æœ‰å¹³å°æ§‹å»ºæˆåŠŸï¼"
          else
            echo "âŒ æ§‹å»ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥æ—¥èªŒ"
            exit 1
          fi
