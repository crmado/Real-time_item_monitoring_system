name: Build C++ Multi-Platform Release

# è§¸ç™¼æ¢ä»¶
on:
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: 2.0.3)"
        required: true
        type: string
      create_release:
        description: "æ˜¯å¦å‰µå»º GitHub Release"
        required: true
        type: boolean
        default: false

  # æ¨é€æ¨™ç±¤æ™‚è‡ªå‹•è§¸ç™¼ (ä¾‹å¦‚: cpp-v2.0.3)
  push:
    tags:
      - "cpp-v*.*.*"
    branches:
      - feature/cpp-rewrite
    paths:
      - "basler_cpp/**"
      - ".github/workflows/build-cpp-release.yml"

  # Pull Request æ™‚é€²è¡Œæ¸¬è©¦æ‰“åŒ…ï¼ˆä¸ä¸Šå‚³ï¼‰
  pull_request:
    branches: [master, main]
    paths:
      - "basler_cpp/**"

env:
  BUILD_TYPE: Release
  QT_VERSION: "6.6.2"

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows æ‰“åŒ…
          - os: windows-latest
            platform: windows
            artifact_name: BaslerVisionSystem-Windows
            cmake_generator: "Visual Studio 17 2022"
            qt_arch: win64_msvc2019_64

          # macOS æ‰“åŒ…
          - os: macos-latest
            platform: macos
            artifact_name: BaslerVisionSystem-macOS
            cmake_generator: "Unix Makefiles"
            qt_arch: clang_64

          # Linux æ‰“åŒ…
          - os: ubuntu-22.04
            platform: linux
            artifact_name: BaslerVisionSystem-Linux
            cmake_generator: "Unix Makefiles"
            qt_arch: gcc_64

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ å®‰è£ Qt (Windows/Linux)
        if: matrix.platform != 'macos'
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ matrix.qt_arch }}
          modules: "qtmultimedia"
          cache: true

      - name: ğŸ”§ å®‰è£ Qt (macOS)
        if: matrix.platform == 'macos'
        run: |
          brew install qt@6
          echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=$(brew --prefix qt@6)" >> $GITHUB_ENV

      - name: ğŸ“¦ å®‰è£ OpenCV (Windows)
        if: matrix.platform == 'windows'
        run: |
          choco install opencv -y
          echo "OpenCV_DIR=C:/tools/opencv/build" >> $env:GITHUB_ENV

      - name: ğŸ“¦ å®‰è£ OpenCV (macOS)
        if: matrix.platform == 'macos'
        run: |
          brew install opencv

      - name: ğŸ“¦ å®‰è£ OpenCV (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libopencv-dev \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libxkbcommon-x11-0 \
            libgl1-mesa-dev \
            libglu1-mesa-dev

      - name: ğŸ“¦ å®‰è£ Pylon SDK (Windows)
        if: matrix.platform == 'windows'
        run: |
          # ä¸‹è¼‰ä¸¦å®‰è£ Pylon SDK
          $PYLON_VERSION = "7.4.0"
          $PYLON_URL = "https://www.baslerweb.com/fp-1726735999/media/downloads/software/pylon_software/Basler_pylon_${PYLON_VERSION}.exe"
          curl -L -o pylon_installer.exe $PYLON_URL
          Start-Process -Wait -FilePath .\pylon_installer.exe -ArgumentList "/quiet", "/norestart"
          echo "PYLON_ROOT=C:/Program Files/Basler/pylon 7/Development" >> $env:GITHUB_ENV
        continue-on-error: true

      - name: ğŸ“¦ æ¨¡æ“¬ Pylon SDK (ç„¡ç›¸æ©Ÿç’°å¢ƒ)
        run: |
          # åœ¨ CI ç’°å¢ƒä¸­å‰µå»ºæ¨¡æ“¬ Pylon é ­æ–‡ä»¶
          mkdir -p basler_cpp/mock_pylon/include/pylon
          echo "// Mock Pylon SDK for CI" > basler_cpp/mock_pylon/include/pylon/PylonIncludes.h
        shell: bash

      - name: ğŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/cpp-v* ]]; then
            # å¾ tag ç²å–ç‰ˆæœ¬è™Ÿ
            VERSION="${GITHUB_REF#refs/tags/cpp-v}"
          else
            # branch push æˆ–å…¶ä»–æƒ…æ³ä½¿ç”¨ dev + çŸ­ SHA
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          # ç¢ºä¿ç‰ˆæœ¬è™Ÿä¸å« / ç­‰éæ³•å­—ç¬¦ï¼ˆç”¨æ–¼æ–‡ä»¶åï¼‰
          VERSION_SAFE=$(echo "$VERSION" | tr '/' '-' | tr ':' '-')
          echo "VERSION=$VERSION_SAFE" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ ç‰ˆæœ¬è™Ÿ: $VERSION_SAFE"

      - name: ğŸ”¨ CMake é…ç½® (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd basler_cpp
          cmake -B build -G "${{ matrix.cmake_generator }}" `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DPYLON_ROOT="${{ env.PYLON_ROOT }}" `
            -DSKIP_PYLON=ON
        shell: pwsh

      - name: ğŸ”¨ CMake é…ç½® (macOS/Linux)
        if: matrix.platform != 'windows'
        run: |
          cd basler_cpp
          cmake -B build -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DSKIP_PYLON=ON

      - name: ğŸ”¨ ç·¨è­¯å°ˆæ¡ˆ
        run: |
          cmake --build basler_cpp/build --config ${{ env.BUILD_TYPE }} --parallel

      - name: ğŸ“ æº–å‚™ç™¼å¸ƒç›®éŒ„
        run: |
          mkdir -p release_output
        shell: bash

      - name: ğŸ æ‰“åŒ… Windows å®‰è£ç¨‹åº
        if: matrix.platform == 'windows'
        run: |
          # è¨­ç½®ç’°å¢ƒè®Šé‡ä¾› Inno Setup ä½¿ç”¨
          $env:APP_VERSION="${{ steps.version.outputs.VERSION }}"

          # èª¿è©¦ï¼šé¡¯ç¤º Qt ç›¸é—œç’°å¢ƒè®Šæ•¸
          Write-Host "=== Qt ç’°å¢ƒè®Šæ•¸ ==="
          Write-Host "Qt6_DIR: $env:Qt6_DIR"
          Write-Host "QT_ROOT_DIR: $env:QT_ROOT_DIR"

          # ç¢ºå®š Qt æ ¹ç›®éŒ„ (install-qt-action è¨­ç½®)
          # Qt6_DIR æ˜¯: D:/a/.../Qt/6.6.2/msvc2019_64 (msvc2019_64 ç›®éŒ„)
          # æ³¨æ„: jurplel/install-qt-action è¨­ç½®çš„ Qt6_DIR ç›´æ¥æŒ‡å‘ msvc2019_64 ç›®éŒ„
          $QT_INSTALL_ROOT = $env:Qt6_DIR
          $QT_BIN = Join-Path $QT_INSTALL_ROOT "bin"

          Write-Host "Qt å®‰è£æ ¹ç›®éŒ„: $QT_INSTALL_ROOT"
          Write-Host "Qt bin è·¯å¾‘: $QT_BIN"

          # é©—è­‰ windeployqt å­˜åœ¨
          $WINDEPLOYQT = Join-Path $QT_BIN "windeployqt.exe"
          if (-not (Test-Path $WINDEPLOYQT)) {
            Write-Host "::error::æ‰¾ä¸åˆ° windeployqt.exe at $WINDEPLOYQT"
          }

          Write-Host "windeployqt è·¯å¾‘: $WINDEPLOYQT"
          Write-Host "windeployqt å­˜åœ¨: $(Test-Path $WINDEPLOYQT)"

          # é‹è¡Œ windeployqt
          if (Test-Path $WINDEPLOYQT) {
            Write-Host "=== åŸ·è¡Œ windeployqt ==="
            & $WINDEPLOYQT --release --no-translations --verbose 2 "basler_cpp\build\Release\BaslerVisionSystem.exe"
            if ($LASTEXITCODE -ne 0) {
              Write-Host "::warning::windeployqt è¿”å›éé›¶ç‹€æ…‹ç¢¼: $LASTEXITCODE"
            }
          } else {
            Write-Host "::error::æ‰¾ä¸åˆ° windeployqt.exeï¼Œæ‰‹å‹•è¤‡è£½ Qt DLLs"
            # æ‰‹å‹•è¤‡è£½ Qt DLLs
            $QT_DLL_DIR = Join-Path $QT_INSTALL_ROOT "bin"
            if (Test-Path $QT_DLL_DIR) {
              Copy-Item "$QT_DLL_DIR\Qt6Core.dll" "basler_cpp\build\Release\" -Force
              Copy-Item "$QT_DLL_DIR\Qt6Gui.dll" "basler_cpp\build\Release\" -Force
              Copy-Item "$QT_DLL_DIR\Qt6Widgets.dll" "basler_cpp\build\Release\" -Force
              Copy-Item "$QT_DLL_DIR\Qt6Network.dll" "basler_cpp\build\Release\" -Force
              # è¤‡è£½ platforms æ’ä»¶
              New-Item -ItemType Directory -Force -Path "basler_cpp\build\Release\platforms" | Out-Null
              Copy-Item (Join-Path $QT_INSTALL_ROOT "plugins\platforms\qwindows.dll") "basler_cpp\build\Release\platforms\" -Force
              # è¤‡è£½ styles æ’ä»¶
              New-Item -ItemType Directory -Force -Path "basler_cpp\build\Release\styles" | Out-Null
              Copy-Item (Join-Path $QT_INSTALL_ROOT "plugins\styles\*") "basler_cpp\build\Release\styles\" -Force -ErrorAction SilentlyContinue
            }
          }

          # è¤‡è£½ OpenCV DLLs
          $OPENCV_BIN = "C:\tools\opencv\build\x64\vc16\bin"
          if (Test-Path $OPENCV_BIN) {
            Write-Host "=== è¤‡è£½ OpenCV DLLs ==="
            Get-ChildItem "$OPENCV_BIN\opencv_world4*.dll" | ForEach-Object {
              Write-Host "  è¤‡è£½: $($_.Name)"
              Copy-Item $_.FullName "basler_cpp\build\Release\" -Force
            }
          }

          # ä¸‹è¼‰ Visual C++ Redistributable
          Write-Host "=== ä¸‹è¼‰ VC++ Redistributable ==="
          $VC_REDIST_URL = "https://aka.ms/vs/17/release/vc_redist.x64.exe"
          $VC_REDIST_PATH = "basler_cpp\installer\vcredist\vc_redist.x64.exe"
          New-Item -ItemType Directory -Force -Path "basler_cpp\installer\vcredist" | Out-Null
          Invoke-WebRequest -Uri $VC_REDIST_URL -OutFile $VC_REDIST_PATH -UseBasicParsing
          Write-Host "VC++ Redistributable ä¸‹è¼‰å®Œæˆ: $(Test-Path $VC_REDIST_PATH)"

          # åˆ—å‡º build/Release ç›®éŒ„å…§å®¹
          Write-Host "=== build/Release ç›®éŒ„å…§å®Œæ•´å…§å®¹ ==="
          Get-ChildItem "basler_cpp\build\Release" -Recurse | ForEach-Object {
            $rel = $_.FullName.Substring((Get-Location).Path.Length + 1)
            $size = if ($_.PSIsContainer) { "[DIR]" } else { "{0:N0} KB" -f ($_.Length/1KB) }
            Write-Host "  $rel - $size"
          }

          # é©—è­‰å¿…è¦çš„æ–‡ä»¶å­˜åœ¨
          Write-Host "=== é©—è­‰å¿…è¦æ–‡ä»¶ ==="
          $REQUIRED_FILES = @(
            "basler_cpp\build\Release\BaslerVisionSystem.exe",
            "basler_cpp\build\Release\Qt6Core.dll",
            "basler_cpp\build\Release\Qt6Gui.dll",
            "basler_cpp\build\Release\Qt6Widgets.dll",
            "basler_cpp\build\Release\platforms\qwindows.dll"
          )
          $missing = $false
          foreach ($file in $REQUIRED_FILES) {
            if (Test-Path $file) {
              Write-Host "âœ“ $file"
            } else {
              Write-Host "::error::âœ— $file ç¼ºå¤±ï¼"
              $missing = $true
            }
          }
          if ($missing) {
            Write-Host "::error::å¿…è¦æ–‡ä»¶ç¼ºå¤±ï¼Œç„¡æ³•ç¹¼çºŒï¼"
            exit 1
          }

          # å‰µå»ºç™¼å¸ƒç›®éŒ„çµæ§‹
          New-Item -ItemType Directory -Force -Path "release_output" | Out-Null

          # å®‰è£ Inno Setup
          Write-Host "=== å®‰è£ Inno Setup ==="
          choco install innosetup -y

          # ç¢ºä¿ releases ç›®éŒ„å­˜åœ¨
          New-Item -ItemType Directory -Force -Path "releases" | Out-Null

          # åˆ‡æ›åˆ° installer ç›®éŒ„ä¸¦ç·¨è­¯ (ç¢ºä¿ç›¸å°è·¯å¾‘æ­£ç¢º)
          Write-Host "=== ç·¨è­¯ Inno Setup å®‰è£ç¨‹åº ==="
          Push-Location "basler_cpp\installer"
          iscc install.iss
          $iscc_result = $LASTEXITCODE
          Pop-Location

          if ($iscc_result -ne 0) {
            Write-Host "::error::Inno Setup ç·¨è­¯å¤±æ•—ï¼é€€å‡ºç¢¼: $iscc_result"
            exit 1
          }

          # åˆ—å‡º releases ç›®éŒ„å…§å®¹
          Write-Host "=== releases ç›®éŒ„å…§å®¹ ==="
          if (Test-Path "releases") {
            Get-ChildItem -Path "releases" -Filter "*.exe" | ForEach-Object {
              Write-Host "  $($_.Name) - $([math]::Round($_.Length/1MB, 2)) MB"
            }
          } else {
            Write-Host "::error::releases ç›®éŒ„ä¸å­˜åœ¨"
            exit 1
          }

          # è¤‡è£½å®‰è£ç¨‹åºåˆ° release_output
          Write-Host "=== è¤‡è£½å®‰è£ç¨‹åºåˆ° release_output ==="
          Get-ChildItem -Path "releases" -Filter "*.exe" | ForEach-Object {
            Write-Host "â†’ è¤‡è£½: $($_.Name) ($([math]::Round($_.Length/1MB, 2)) MB)"
            Copy-Item $_.FullName -Destination "release_output\"
          }

          # æœ€çµ‚é©—è­‰
          Write-Host "=== æœ€çµ‚é©—è­‰ ==="
          $installers = Get-ChildItem -Path "release_output" -Filter "*Setup*.exe"
          if ($installers.Count -eq 0) {
            Write-Host "::error::æœªæ‰¾åˆ°å®‰è£ç¨‹åºï¼"
            exit 1
          }
          foreach ($installer in $installers) {
            Write-Host "âœ“ å®‰è£ç¨‹åº: $($installer.Name) - $([math]::Round($installer.Length/1MB, 2)) MB"
            if ($installer.Length -lt 5MB) {
              Write-Host "::warning::å®‰è£ç¨‹åºå¤§å°ç•°å¸¸å° (< 5MB)ï¼Œå¯èƒ½ç¼ºå°‘ DLLs"
            }
          }
        shell: pwsh

      - name: ğŸ æ‰“åŒ… macOS DMG
        if: matrix.platform == 'macos'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          APP_NAME="BaslerVisionSystem"
          DMG_NAME="BaslerVisionSystem_v${VERSION}_macOS.dmg"

          # è¤‡è£½ assets åˆ° app bundle
          if [ -d "basler_cpp/assets" ]; then
            mkdir -p "basler_cpp/build/${APP_NAME}.app/Contents/Resources/"
            cp -R basler_cpp/assets "basler_cpp/build/${APP_NAME}.app/Contents/Resources/"
          fi

          # éƒ¨ç½² Qt ä¾è³´
          $(brew --prefix qt@6)/bin/macdeployqt "basler_cpp/build/${APP_NAME}.app"

          # Ad-hoc code signingï¼ˆé˜²æ­¢ macOS Gatekeeper é¡¯ç¤ºã€Œæª”æ¡ˆå·²æå£ã€éŒ¯èª¤ï¼‰
          echo "=== Ad-hoc Code Signing ==="
          codesign --force --deep --sign - "basler_cpp/build/${APP_NAME}.app"
          echo "ç°½åé©—è­‰:"
          codesign --verify --verbose "basler_cpp/build/${APP_NAME}.app" || true

          # å‰µå»º DMG
          brew install create-dmg
          create-dmg \
            --volname "Basler Vision System" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "release_output/${DMG_NAME}" \
            "basler_cpp/build/${APP_NAME}.app"

          # é©—è­‰ DMG ç”Ÿæˆï¼ˆcreate-dmg å¯èƒ½å› ç¼ºå°‘åœ–æ¨™ç­‰éé—œéµåŸå› å¤±æ•—ï¼‰
          if [ ! -f "release_output/${DMG_NAME}" ]; then
            echo "::warning::create-dmg å¤±æ•—ï¼Œä½¿ç”¨ hdiutil å»ºç«‹åŸºæœ¬ DMG"
            hdiutil create -volname "Basler Vision System" \
              -srcfolder "basler_cpp/build/${APP_NAME}.app" \
              -ov -format UDZO \
              "release_output/${DMG_NAME}"
          fi
          echo "âœ“ DMG: $(ls -lh "release_output/${DMG_NAME}")"

      - name: ğŸ æ‰“åŒ… Linux AppImage
        if: matrix.platform == 'linux'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          APP_NAME="BaslerVisionSystem"
          APPIMAGE_NAME="BaslerVisionSystem_v${VERSION}_Linux.AppImage"

          # å®‰è£ linuxdeployï¼ˆä½¿ç”¨ extract-and-run å› ç‚º GitHub Actions æ²’æœ‰ FUSEï¼‰
          wget -q https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget -q https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-*.AppImage

          # å‰µå»º AppDir çµæ§‹
          mkdir -p AppDir/usr/bin AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # è¤‡è£½åŸ·è¡Œæ–‡ä»¶
          cp "basler_cpp/build/${APP_NAME}" AppDir/usr/bin/

          # è¤‡è£½ assets
          if [ -d "basler_cpp/assets" ]; then
            cp -R basler_cpp/assets AppDir/usr/share/
          fi

          # å‰µå»º .desktop æ–‡ä»¶ï¼ˆç”¨ printf é¿å… heredoc ç ´å£ YAML ç¸®æ’ï¼‰
          printf '%s\n' \
            "[Desktop Entry]" \
            "Type=Application" \
            "Name=Basler Vision System" \
            "Comment=Industrial Vision Detection System" \
            "Exec=BaslerVisionSystem" \
            "Icon=BaslerVisionSystem" \
            "Categories=Utility;Development;" \
            "Terminal=false" \
            > "AppDir/usr/share/applications/${APP_NAME}.desktop"
          cp "AppDir/usr/share/applications/${APP_NAME}.desktop" AppDir/

          # å‰µå»ºç°¡æ˜“åœ–æ¨™ï¼ˆç”¨ ImageMagick æˆ–å»ºç«‹ä½”ä½ PNGï¼‰
          if [ -f "basler_cpp/assets/icon.png" ]; then
            cp basler_cpp/assets/icon.png "AppDir/usr/share/icons/hicolor/256x256/apps/${APP_NAME}.png"
          else
            convert -size 256x256 xc:steelblue -gravity center -fill white -pointsize 40 -annotate 0 "BVS" \
              "AppDir/usr/share/icons/hicolor/256x256/apps/${APP_NAME}.png" 2>/dev/null || \
            python3 -c "
          import struct,zlib,sys;w=h=256;r,g,b=70,130,180
          raw=b''.join(b'\x00'+bytes([r,g,b])*w for _ in range(h))
          c=lambda t,d:struct.pack('>I',len(d))+t+d+struct.pack('>I',zlib.crc32(t+d)&0xffffffff)
          sys.stdout.buffer.write(b'\x89PNG\r\n\x1a\n'+c(b'IHDR',struct.pack('>IIBBBBB',w,h,8,2,0,0,0))+c(b'IDAT',zlib.compress(raw))+c(b'IEND',b''))
          " > "AppDir/usr/share/icons/hicolor/256x256/apps/${APP_NAME}.png"
          fi
          cp "AppDir/usr/share/icons/hicolor/256x256/apps/${APP_NAME}.png" AppDir/ 2>/dev/null || true

          # ç”Ÿæˆ AppImageï¼ˆAPPIMAGE_EXTRACT_AND_RUN=1 ç¹é FUSE é™åˆ¶ï¼‰
          export APPIMAGE_EXTRACT_AND_RUN=1
          export QMAKE="$(which qmake6 2>/dev/null || which qmake 2>/dev/null || echo "")"
          ./linuxdeploy-x86_64.AppImage \
            --appdir AppDir \
            --plugin qt \
            --desktop-file "AppDir/usr/share/applications/${APP_NAME}.desktop" \
            --icon-file "AppDir/usr/share/icons/hicolor/256x256/apps/${APP_NAME}.png" \
            --output appimage

          # ç§»å‹•åˆ°è¼¸å‡ºç›®éŒ„ï¼ˆappimagetool æ ¹æ“š .desktop Name æ¬„ä½å‘½åï¼Œ
          # "Basler Vision System" â†’ "Basler_Vision_System-x86_64.AppImage"ï¼Œ
          # éœ€æ’é™¤ linuxdeploy å·¥å…·æœ¬èº«çš„ AppImageï¼‰
          GENERATED=$(find . -maxdepth 1 -name "*.AppImage" ! -name "linuxdeploy*" -print -quit)
          if [ -n "$GENERATED" ]; then
            mv "$GENERATED" "release_output/${APPIMAGE_NAME}"
            echo "âœ“ AppImage: $(ls -lh "release_output/${APPIMAGE_NAME}")"
          else
            echo "::error::æ‰¾ä¸åˆ°ç”Ÿæˆçš„ AppImage æ–‡ä»¶ï¼"
            ls -la *.AppImage 2>/dev/null || echo "ç›®éŒ„ä¸­æ²’æœ‰ä»»ä½• .AppImage æ–‡ä»¶"
            exit 1
          fi

      - name: ğŸ“¤ ä¸Šå‚³å·¥ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-${{ steps.version.outputs.VERSION }}
          path: release_output/*
          retention-days: 30

  # å‰µå»º Release
  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/cpp-v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')

    steps:
      - name: ğŸ“¥ ä¸‹è¼‰æ‰€æœ‰å·¥ä»¶
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“‹ åˆ—å‡ºå·¥ä»¶
        run: |
          echo "ğŸ“¦ å·²ä¸‹è¼‰çš„å·¥ä»¶:"
          find artifacts -type f | head -50

      - name: ğŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/cpp-v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ‰ å‰µå»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: cpp-v${{ steps.version.outputs.VERSION }}
          name: "Basler Vision System (C++) v${{ steps.version.outputs.VERSION }}"
          body: |
            ## Basler Vision System (C++ ç‰ˆæœ¬) v${{ steps.version.outputs.VERSION }}

            ### ğŸ†• ç‰ˆæœ¬èªªæ˜
            C++ åŸç”Ÿç‰ˆæœ¬ï¼Œæä¾›æ›´é«˜çš„æ€§èƒ½å’Œæ›´ä½çš„è³‡æºä½”ç”¨ã€‚

            ### ğŸ“¦ å®‰è£åŒ…
            - **Windows**: `BaslerVisionSystem_v${{ steps.version.outputs.VERSION }}_Setup.exe`
            - **macOS**: `BaslerVisionSystem_v${{ steps.version.outputs.VERSION }}_macOS.dmg`
            - **Linux**: `BaslerVisionSystem_v${{ steps.version.outputs.VERSION }}_Linux.AppImage`

            ### ğŸ“‹ ç³»çµ±éœ€æ±‚
            - **Windows**: Windows 10/11 (64-bit)
            - **macOS**: macOS 11.0 (Big Sur) æˆ–æ›´é«˜
            - **Linux**: Ubuntu 20.04+ æˆ–ç›¸å®¹ç™¼è¡Œç‰ˆ

            ### ğŸ“¦ ä¾è³´
            - Qt 6.6+
            - OpenCV 4.x
            - Basler Pylon SDK 7.x (å¦‚ä½¿ç”¨ç›¸æ©Ÿ)

            ### ğŸ“ è®Šæ›´è¨˜éŒ„
            - è«‹åƒé–± [CHANGELOG.md](CHANGELOG.md)
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
