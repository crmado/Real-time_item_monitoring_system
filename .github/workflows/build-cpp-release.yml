name: Build C++ Multi-Platform Release

# è§¸ç™¼æ¢ä»¶
on:
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
    inputs:
      version:
        description: "ç‰ˆæœ¬è™Ÿ (ä¾‹å¦‚: 2.0.3)"
        required: true
        type: string
      create_release:
        description: "æ˜¯å¦å‰µå»º GitHub Release"
        required: true
        type: boolean
        default: false

  # æ¨é€æ¨™ç±¤æ™‚è‡ªå‹•è§¸ç™¼ (ä¾‹å¦‚: cpp-v2.0.3)
  push:
    tags:
      - "cpp-v*.*.*"
    branches:
      - feature/cpp-rewrite
    paths:
      - "basler_cpp/**"
      - ".github/workflows/build-cpp-release.yml"

  # Pull Request æ™‚é€²è¡Œæ¸¬è©¦æ‰“åŒ…ï¼ˆä¸ä¸Šå‚³ï¼‰
  pull_request:
    branches: [master, main]
    paths:
      - "basler_cpp/**"

env:
  BUILD_TYPE: Release
  QT_VERSION: "6.6.2"

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Windows æ‰“åŒ…
          - os: windows-latest
            platform: windows
            artifact_name: BaslerVisionSystem-Windows
            cmake_generator: "Visual Studio 17 2022"
            qt_arch: win64_msvc2019_64

          # macOS æ‰“åŒ…
          - os: macos-latest
            platform: macos
            artifact_name: BaslerVisionSystem-macOS
            cmake_generator: "Unix Makefiles"
            qt_arch: clang_64

          # Linux æ‰“åŒ…
          - os: ubuntu-22.04
            platform: linux
            artifact_name: BaslerVisionSystem-Linux
            cmake_generator: "Unix Makefiles"
            qt_arch: gcc_64

    steps:
      - name: ğŸ“¥ æª¢å‡ºä»£ç¢¼
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ å®‰è£ Qt (Windows/Linux)
        if: matrix.platform != 'macos'
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          arch: ${{ matrix.qt_arch }}
          modules: "qtmultimedia"
          cache: true

      - name: ğŸ”§ å®‰è£ Qt (macOS)
        if: matrix.platform == 'macos'
        run: |
          brew install qt@6
          echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV
          echo "CMAKE_PREFIX_PATH=$(brew --prefix qt@6)" >> $GITHUB_ENV

      - name: ğŸ“¦ å®‰è£ OpenCV (Windows)
        if: matrix.platform == 'windows'
        run: |
          choco install opencv -y
          echo "OpenCV_DIR=C:/tools/opencv/build" >> $env:GITHUB_ENV

      - name: ğŸ“¦ å®‰è£ OpenCV (macOS)
        if: matrix.platform == 'macos'
        run: |
          brew install opencv

      - name: ğŸ“¦ å®‰è£ OpenCV (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libopencv-dev \
            libxcb-xinerama0 \
            libxcb-cursor0 \
            libxkbcommon-x11-0 \
            libgl1-mesa-dev \
            libglu1-mesa-dev

      - name: ğŸ“¦ å®‰è£ Pylon SDK (Windows)
        if: matrix.platform == 'windows'
        run: |
          # ä¸‹è¼‰ä¸¦å®‰è£ Pylon SDK
          $PYLON_VERSION = "7.4.0"
          $PYLON_URL = "https://www.baslerweb.com/fp-1726735999/media/downloads/software/pylon_software/Basler_pylon_${PYLON_VERSION}.exe"
          curl -L -o pylon_installer.exe $PYLON_URL
          Start-Process -Wait -FilePath .\pylon_installer.exe -ArgumentList "/quiet", "/norestart"
          echo "PYLON_ROOT=C:/Program Files/Basler/pylon 7/Development" >> $env:GITHUB_ENV
        continue-on-error: true

      - name: ğŸ“¦ æ¨¡æ“¬ Pylon SDK (ç„¡ç›¸æ©Ÿç’°å¢ƒ)
        run: |
          # åœ¨ CI ç’°å¢ƒä¸­å‰µå»ºæ¨¡æ“¬ Pylon é ­æ–‡ä»¶
          mkdir -p basler_cpp/mock_pylon/include/pylon
          echo "// Mock Pylon SDK for CI" > basler_cpp/mock_pylon/include/pylon/PylonIncludes.h
        shell: bash

      - name: ğŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          elif [[ "$GITHUB_REF" == refs/tags/cpp-v* ]]; then
            # å¾ tag ç²å–ç‰ˆæœ¬è™Ÿ
            VERSION="${GITHUB_REF#refs/tags/cpp-v}"
          else
            # branch push æˆ–å…¶ä»–æƒ…æ³ä½¿ç”¨ dev + çŸ­ SHA
            VERSION="dev-$(git rev-parse --short HEAD)"
          fi
          # ç¢ºä¿ç‰ˆæœ¬è™Ÿä¸å« / ç­‰éæ³•å­—ç¬¦ï¼ˆç”¨æ–¼æ–‡ä»¶åï¼‰
          VERSION_SAFE=$(echo "$VERSION" | tr '/' '-' | tr ':' '-')
          echo "VERSION=$VERSION_SAFE" >> $GITHUB_OUTPUT
          echo "ğŸ“Œ ç‰ˆæœ¬è™Ÿ: $VERSION_SAFE"

      - name: ğŸ”¨ CMake é…ç½® (Windows)
        if: matrix.platform == 'windows'
        run: |
          cd basler_cpp
          cmake -B build -G "${{ matrix.cmake_generator }}" `
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} `
            -DPYLON_ROOT="${{ env.PYLON_ROOT }}" `
            -DSKIP_PYLON=ON
        shell: pwsh

      - name: ğŸ”¨ CMake é…ç½® (macOS/Linux)
        if: matrix.platform != 'windows'
        run: |
          cd basler_cpp
          cmake -B build -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }} \
            -DSKIP_PYLON=ON

      - name: ğŸ”¨ ç·¨è­¯å°ˆæ¡ˆ
        run: |
          cmake --build basler_cpp/build --config ${{ env.BUILD_TYPE }} --parallel

      - name: ğŸ“ æº–å‚™ç™¼å¸ƒç›®éŒ„
        run: |
          mkdir -p release_output
        shell: bash

      - name: ğŸ æ‰“åŒ… Windows å®‰è£ç¨‹åº
        if: matrix.platform == 'windows'
        run: |
          # è¨­ç½®ç’°å¢ƒè®Šé‡ä¾› Inno Setup ä½¿ç”¨
          $env:APP_VERSION="${{ steps.version.outputs.VERSION }}"

          # èª¿è©¦ï¼šé¡¯ç¤º Qt ç›¸é—œç’°å¢ƒè®Šæ•¸
          Write-Host "=== Qt ç’°å¢ƒè®Šæ•¸ ==="
          Write-Host "Qt6_DIR: $env:Qt6_DIR"
          Write-Host "QT_ROOT_DIR: $env:QT_ROOT_DIR"

          # ç¢ºå®š windeployqt ä½ç½®
          # install-qt-action è¨­ç½® Qt6_DIR ç‚º cmake ç›®éŒ„ï¼Œéœ€è¦æ‰¾åˆ° bin ç›®éŒ„
          $QT_ROOT = Split-Path -Parent $env:Qt6_DIR
          $QT_BIN = Join-Path $QT_ROOT "bin"
          
          # å¦‚æœä¸Šé¢çš„è·¯å¾‘ä¸å°ï¼Œå˜—è©¦ç›´æ¥ä½¿ç”¨ Qt6_DIR çš„ bin å­ç›®éŒ„
          if (-not (Test-Path "$QT_BIN\windeployqt.exe")) {
            $QT_BIN = "$env:Qt6_DIR\bin"
          }
          
          # å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ°ï¼Œå˜—è©¦å¾ Qt6_DIR ä¸Šæº¯
          if (-not (Test-Path "$QT_BIN\windeployqt.exe")) {
            # Qt6_DIR å¯èƒ½æ˜¯ .../msvc2019_64/lib/cmake/Qt6
            $QT_BIN = (Get-Item $env:Qt6_DIR).Parent.Parent.Parent.FullName + "\bin"
          }

          Write-Host "Qt bin è·¯å¾‘: $QT_BIN"
          Write-Host "windeployqt å­˜åœ¨: $(Test-Path "$QT_BIN\windeployqt.exe")"

          # åˆ—å‡º Qt bin ç›®éŒ„å…§å®¹
          if (Test-Path $QT_BIN) {
            Write-Host "=== Qt bin ç›®éŒ„å…§å®¹ ==="
            Get-ChildItem $QT_BIN -Filter "*.exe" | Select-Object Name
          }

          # é‹è¡Œ windeployqt
          $WINDEPLOYQT = Join-Path $QT_BIN "windeployqt.exe"
          if (Test-Path $WINDEPLOYQT) {
            Write-Host "åŸ·è¡Œ windeployqt..."
            & $WINDEPLOYQT --release --no-translations "basler_cpp\build\Release\BaslerVisionSystem.exe"
            if ($LASTEXITCODE -ne 0) {
              Write-Host "::warning::windeployqt è¿”å›éé›¶ç‹€æ…‹ç¢¼: $LASTEXITCODE"
            }
          } else {
            Write-Host "::error::æ‰¾ä¸åˆ° windeployqt.exeï¼Œæ‰‹å‹•è¤‡è£½ Qt DLLs"
            # æ‰‹å‹•è¤‡è£½ Qt DLLs
            $QT_DLL_DIR = Join-Path (Split-Path $QT_BIN) "bin"
            if (Test-Path $QT_DLL_DIR) {
              Copy-Item "$QT_DLL_DIR\Qt6Core.dll" "basler_cpp\build\Release\" -ErrorAction SilentlyContinue
              Copy-Item "$QT_DLL_DIR\Qt6Gui.dll" "basler_cpp\build\Release\" -ErrorAction SilentlyContinue
              Copy-Item "$QT_DLL_DIR\Qt6Widgets.dll" "basler_cpp\build\Release\" -ErrorAction SilentlyContinue
              Copy-Item "$QT_DLL_DIR\Qt6Multimedia.dll" "basler_cpp\build\Release\" -ErrorAction SilentlyContinue
              Copy-Item "$QT_DLL_DIR\Qt6MultimediaWidgets.dll" "basler_cpp\build\Release\" -ErrorAction SilentlyContinue
              Copy-Item "$QT_DLL_DIR\Qt6Network.dll" "basler_cpp\build\Release\" -ErrorAction SilentlyContinue
              # è¤‡è£½ platforms æ’ä»¶
              New-Item -ItemType Directory -Force -Path "basler_cpp\build\Release\platforms" | Out-Null
              Copy-Item "$QT_DLL_DIR\..\plugins\platforms\qwindows.dll" "basler_cpp\build\Release\platforms\" -ErrorAction SilentlyContinue
            }
          }

          # è¤‡è£½ OpenCV DLLs
          $OPENCV_BIN = "C:\tools\opencv\build\x64\vc16\bin"
          if (Test-Path $OPENCV_BIN) {
            Write-Host "è¤‡è£½ OpenCV DLLs from $OPENCV_BIN"
            Copy-Item "$OPENCV_BIN\opencv_world4*.dll" "basler_cpp\build\Release\" -ErrorAction SilentlyContinue
          }

          # åˆ—å‡º build/Release ç›®éŒ„å…§å®¹ä»¥ç¢ºèª DLLs æ˜¯å¦å­˜åœ¨
          Write-Host "=== build/Release ç›®éŒ„å…§å®¹ ==="
          Get-ChildItem "basler_cpp\build\Release" | Select-Object Name

          # é©—è­‰å¿…è¦çš„ DLLs å­˜åœ¨
          $REQUIRED_DLLS = @("Qt6Core.dll", "Qt6Gui.dll", "Qt6Widgets.dll")
          foreach ($dll in $REQUIRED_DLLS) {
            if (Test-Path "basler_cpp\build\Release\$dll") {
              Write-Host "âœ“ $dll å­˜åœ¨"
            } else {
              Write-Host "::error::âœ— $dll ç¼ºå¤±ï¼"
            }
          }

          # å‰µå»ºç™¼å¸ƒç›®éŒ„çµæ§‹
          New-Item -ItemType Directory -Force -Path "release_output\BaslerVisionSystem" | Out-Null

          # è¤‡è£½åŸ·è¡Œæ–‡ä»¶
          Copy-Item "basler_cpp\build\Release\BaslerVisionSystem.exe" "release_output\BaslerVisionSystem\"

          # è¤‡è£½ assets
          if (Test-Path "basler_cpp\assets") {
            Copy-Item -Recurse "basler_cpp\assets" "release_output\BaslerVisionSystem\assets"
          }

          # è¤‡è£½é…ç½®æ–‡ä»¶
          New-Item -ItemType Directory -Force -Path "release_output\BaslerVisionSystem\config" | Out-Null

          # å®‰è£ Inno Setup
          choco install innosetup -y

          # ç¢ºä¿ releases ç›®éŒ„å­˜åœ¨ (install.iss OutputDir çš„è¼¸å‡ºç›®æ¨™)
          New-Item -ItemType Directory -Force -Path "releases" | Out-Null

          # ç·¨è­¯å®‰è£ç¨‹åº
          Write-Host "ğŸ“¦ ç·¨è­¯ Inno Setup å®‰è£ç¨‹åº..."
          iscc basler_cpp/installer/install.iss
          
          # æª¢æŸ¥ç·¨è­¯çµæœ
          if ($LASTEXITCODE -ne 0) {
            Write-Host "::error::Inno Setup ç·¨è­¯å¤±æ•—ï¼"
            exit 1
          }

          # åˆ—å‡º releases ç›®éŒ„å…§å®¹ (install.iss OutputDir=..\..\releases)
          Write-Host "ğŸ“‹ releases ç›®éŒ„å…§å®¹:"
          if (Test-Path "releases") {
            Get-ChildItem -Path "releases" | ForEach-Object { Write-Host "  $($_.Name)" }
          } else {
            Write-Host "::warning::releases ç›®éŒ„ä¸å­˜åœ¨"
          }

          # è¤‡è£½å®‰è£ç¨‹åºåˆ° release_output (æ­£ç¢ºè·¯å¾‘ï¼šé …ç›®æ ¹ç›®éŒ„çš„ releases/)
          Write-Host "ğŸ“¦ è¤‡è£½å®‰è£ç¨‹åºåˆ° release_output..."
          Get-ChildItem -Path "releases" -Filter "*.exe" 2>$null | ForEach-Object {
            Write-Host "â†’ è¤‡è£½: $($_.Name)"
            Copy-Item $_.FullName -Destination "release_output\"
          }
          
          # åˆ—å‡º release_output æœ€çµ‚å…§å®¹
          Write-Host "ğŸ“‹ release_output ç›®éŒ„æœ€çµ‚å…§å®¹:"
          Get-ChildItem -Path "release_output" -Recurse | ForEach-Object {
            $size = if ($_.PSIsContainer) { "[DIR]" } else { "{0:N0} KB" -f ($_.Length/1KB) }
            Write-Host "  $($_.FullName) - $size"
          }
        shell: pwsh

      - name: ğŸ æ‰“åŒ… macOS DMG
        if: matrix.platform == 'macos'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          APP_NAME="BaslerVisionSystem"
          DMG_NAME="BaslerVisionSystem_v${VERSION}_macOS.dmg"

          # è¤‡è£½ assets åˆ° app bundle
          if [ -d "basler_cpp/assets" ]; then
            cp -R basler_cpp/assets "basler_cpp/build/${APP_NAME}.app/Contents/Resources/"
          fi

          # éƒ¨ç½² Qt ä¾è³´
          brew install qt@6
          $(brew --prefix qt@6)/bin/macdeployqt "basler_cpp/build/${APP_NAME}.app"

          # å‰µå»º DMG
          brew install create-dmg
          create-dmg \
            --volname "Basler Vision System" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            "release_output/${DMG_NAME}" \
            "basler_cpp/build/${APP_NAME}.app" || true

      - name: ğŸ æ‰“åŒ… Linux AppImage
        if: matrix.platform == 'linux'
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          APP_NAME="BaslerVisionSystem"
          APPIMAGE_NAME="BaslerVisionSystem_v${VERSION}_Linux.AppImage"

          # å®‰è£ linuxdeploy
          wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
          wget https://github.com/linuxdeploy/linuxdeploy-plugin-qt/releases/download/continuous/linuxdeploy-plugin-qt-x86_64.AppImage
          chmod +x linuxdeploy-*.AppImage

          # å‰µå»º AppDir çµæ§‹
          mkdir -p AppDir/usr/bin
          mkdir -p AppDir/usr/lib
          mkdir -p AppDir/usr/share/applications
          mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps

          # è¤‡è£½åŸ·è¡Œæ–‡ä»¶
          cp basler_cpp/build/${APP_NAME} AppDir/usr/bin/

          # è¤‡è£½ assets
          if [ -d "basler_cpp/assets" ]; then
            cp -R basler_cpp/assets AppDir/usr/share/
          fi

          # å‰µå»º .desktop æ–‡ä»¶
          cat > AppDir/usr/share/applications/${APP_NAME}.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=Basler Vision System
          Comment=å·¥æ¥­è¦–è¦ºæª¢æ¸¬ç³»çµ± (C++ ç‰ˆæœ¬)
          Exec=${APP_NAME}
          Icon=${APP_NAME}
          Categories=Utility;Development;
          Terminal=false
          EOF

          # å‰µå»ºç°¡æ˜“åœ–æ¨™ (å¦‚æœæ²’æœ‰çš„è©±)
          if [ ! -f "basler_cpp/assets/icon.png" ]; then
            convert -size 256x256 xc:blue AppDir/usr/share/icons/hicolor/256x256/apps/${APP_NAME}.png || \
            touch AppDir/usr/share/icons/hicolor/256x256/apps/${APP_NAME}.png
          else
            cp basler_cpp/assets/icon.png AppDir/usr/share/icons/hicolor/256x256/apps/${APP_NAME}.png
          fi

          # ç”Ÿæˆ AppImage
          ./linuxdeploy-x86_64.AppImage --appdir AppDir --plugin qt --output appimage || true

          # ç§»å‹•åˆ°è¼¸å‡ºç›®éŒ„
          mv *.AppImage release_output/${APPIMAGE_NAME} || true

      - name: ğŸ“¤ ä¸Šå‚³å·¥ä»¶
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}-${{ steps.version.outputs.VERSION }}
          path: release_output/*
          retention-days: 30

  # å‰µå»º Release
  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/cpp-v')) ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.create_release == 'true')

    steps:
      - name: ğŸ“¥ ä¸‹è¼‰æ‰€æœ‰å·¥ä»¶
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: ğŸ“‹ åˆ—å‡ºå·¥ä»¶
        run: |
          echo "ğŸ“¦ å·²ä¸‹è¼‰çš„å·¥ä»¶:"
          find artifacts -type f | head -50

      - name: ğŸ“ ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/cpp-v}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: ğŸ‰ å‰µå»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: cpp-v${{ steps.version.outputs.VERSION }}
          name: "Basler Vision System (C++) v${{ steps.version.outputs.VERSION }}"
          body: |
            ## Basler Vision System (C++ ç‰ˆæœ¬) v${{ steps.version.outputs.VERSION }}

            ### ğŸ†• ç‰ˆæœ¬èªªæ˜
            C++ åŸç”Ÿç‰ˆæœ¬ï¼Œæä¾›æ›´é«˜çš„æ€§èƒ½å’Œæ›´ä½çš„è³‡æºä½”ç”¨ã€‚

            ### ğŸ“¦ å®‰è£åŒ…
            - **Windows**: `BaslerVisionSystem_v${{ steps.version.outputs.VERSION }}_Setup.exe`
            - **macOS**: `BaslerVisionSystem_v${{ steps.version.outputs.VERSION }}_macOS.dmg`
            - **Linux**: `BaslerVisionSystem_v${{ steps.version.outputs.VERSION }}_Linux.AppImage`

            ### ğŸ“‹ ç³»çµ±éœ€æ±‚
            - **Windows**: Windows 10/11 (64-bit)
            - **macOS**: macOS 11.0 (Big Sur) æˆ–æ›´é«˜
            - **Linux**: Ubuntu 20.04+ æˆ–ç›¸å®¹ç™¼è¡Œç‰ˆ

            ### ğŸ“¦ ä¾è³´
            - Qt 6.6+
            - OpenCV 4.x
            - Basler Pylon SDK 7.x (å¦‚ä½¿ç”¨ç›¸æ©Ÿ)

            ### ğŸ“ è®Šæ›´è¨˜éŒ„
            - è«‹åƒé–± [CHANGELOG.md](CHANGELOG.md)
          files: |
            artifacts/**/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
